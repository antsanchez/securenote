<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Secure Note + Tools</title>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: 2em auto; }
    textarea, input { width: 100%; padding: 0.5em; margin: 0.5em 0; }
    textarea { height: 150px; } /* Increased height */
    button { padding: 0.5em 1em; margin: 0.5em 0; }
    .output-box { word-break: break-word; white-space: pre-wrap; background: #f2f2f2; padding: 1em; min-height: 50px; } /* Added min-height */
    .tabs button { margin-right: 1em; }
    .tab-section { display: none; }
    .tab-section.active { display: block; }
    .info-text { font-size: 0.9em; color: #555; margin-bottom: 1em; } /* Style for info text */
    footer { margin-top: 2em; padding-top: 1em; border-top: 1px solid #ccc; text-align: center; font-size: 0.9em; color: #666; }
    footer a { margin: 0 0.5em; color: #333; text-decoration: none; }
    footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h1>üîê Secure Note Utility</h1>
  <div class="tabs">
    <button onclick="switchTab('encrypt')">üîí Encrypt</button>
    <button onclick="switchTab('decrypt')">üîì Decrypt</button>
    <button onclick="switchTab('replace')">üîÅ Replace Characters</button>
  </div>

  <!-- Encrypt -->
  <div id="encrypt" class="tab-section active">
    <h2>Encrypt Message</h2>
    <p class="info-text">Enter your message and a password. The tool will encrypt your text using AES-GCM encryption. The output can only be decrypted with the correct password.</p>
    <textarea id="plainText" placeholder="Enter your secret message..."></textarea>
    <input type="password" id="encryptPassword" placeholder="Password">
    <button onclick="encryptNote()">Encrypt</button>
    <div class="output-box" id="encryptedOutput"></div>
  </div>

  <!-- Decrypt -->
  <div id="decrypt" class="tab-section">
    <h2>Decrypt Message</h2>
    <p class="info-text">Paste the encrypted message (the long string of characters generated by the encrypt tool) and enter the original password to reveal the original text.</p>
    <textarea id="encryptedText" placeholder="Paste encrypted message here..."></textarea>
    <input type="password" id="decryptPassword" placeholder="Password">
    <button onclick="decryptNote()">Decrypt</button>
    <div class="output-box" id="decryptedOutput"></div>
  </div>

  <!-- Replace Characters -->
  <div id="replace" class="tab-section">
    <h2>Replace Characters</h2>
    <p class="info-text">Enter text and specify two single characters. The tool will swap every instance of the 'From' character with the 'To' character, and vice-versa, throughout the text.</p>
    <textarea id="replaceInput" placeholder="Enter text to modify..."></textarea>
    <input type="text" id="fromChar" maxlength="1" placeholder="From (e.g., a)">
    <input type="text" id="toChar" maxlength="1" placeholder="To (e.g., b)">
    <button onclick="replaceChars()">Replace</button>
    <div class="output-box" id="replaceOutput"></div>
  </div>

  <script>
    // Tab switching
    function switchTab(tabId) {
      document.querySelectorAll('.tab-section').forEach(sec => {
        sec.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
    }

    // Encryption / Decryption Functions
    async function getKey(password, salt) {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]
      );
      return crypto.subtle.deriveKey(
        {
          name: "PBKDF2",
          salt,
          iterations: 100000,
          hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
      );
    }

    async function encryptNote() {
      const plainText = document.getElementById('plainText').value;
      const password = document.getElementById('encryptPassword').value;
      const enc = new TextEncoder();
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const key = await getKey(password, salt);
      const cipherText = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        enc.encode(plainText)
      );

      const data = {
        iv: Array.from(iv),
        salt: Array.from(salt),
        cipher: Array.from(new Uint8Array(cipherText))
      };

      document.getElementById('encryptedOutput').textContent = btoa(JSON.stringify(data));
    }

    async function decryptNote() {
      const encryptedText = document.getElementById('encryptedText').value;
      const password = document.getElementById('decryptPassword').value;
      try {
        const data = JSON.parse(atob(encryptedText));
        const iv = new Uint8Array(data.iv);
        const salt = new Uint8Array(data.salt);
        const cipher = new Uint8Array(data.cipher);
        const key = await getKey(password, salt);
        const decrypted = await crypto.subtle.decrypt(
          { name: "AES-GCM", iv },
          key,
          cipher
        );
        const dec = new TextDecoder();
        document.getElementById('decryptedOutput').textContent = dec.decode(decrypted);
      } catch (e) {
        document.getElementById('decryptedOutput').textContent = "‚ùå Decryption failed.";
      }
    }

    // Character Replacement
    function replaceChars() {
        const input = document.getElementById('replaceInput').value;
        const from = document.getElementById('fromChar').value;
        const to = document.getElementById('toChar').value;

        if (from.length !== 1 || to.length !== 1) {
            alert("Please enter single characters to swap.");
            return;
        }

        // Swap characters safely using placeholder
        const tempChar = '\u0001'; // A rarely-used control char as placeholder
        const step1 = input.split(from).join(tempChar);
        const step2 = step1.split(to).join(from);
        const result = step2.split(tempChar).join(to);

        document.getElementById('replaceOutput').textContent = result;
    }

  </script>

  <footer>
    <a href="https://asanchez.dev" target="_blank" rel="noopener noreferrer">asanchez.dev</a> |
    <a href="https://asanchez.dev/site-notice/" target="_blank" rel="noopener noreferrer">Site Notice</a> |
    <a href="https://asanchez.dev/privacy/" target="_blank" rel="noopener noreferrer">Privacy Policy</a>
  </footer>
</body>
</html>
